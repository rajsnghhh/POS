<div class="page-header-main">
    <div class="row align-items-center justify-content-between">
        <div class="col-md-auto col-sm-auto col">
            <div class="content-header">
                <h1>{{'INVENTORIES' | translate}}</h1>
            </div>
        </div>

        <div *hasClaim="'INVE_MANAGE_INVENTORY'" class="col-md-auto col-sm-auto col-auto">
            <input type="file" #fileInput (change)="uploadFile($event)" style="display: none" />
            <button class="btn blue-btn btn-sm m-right-10" (click)="downloadInventory()">
                <i class="fas fa-download"></i> Download Inventory Excel Format
            </button>

            <button class="btn blue-btn btn-sm m-right-10" data-toggle="modal" data-target="#exampleModal">
                <i class="fas fa-upload"></i> Upload Inventory
            </button>

            <button class="btn blue-btn btn-sm m-right-10" (click)="addInventory({})">
                <i class="fas fa-plus"></i> {{'ADD_INVENTORY' | translate}}
            </button>

            <button class="btn blue-btn btn-sm m-right-10" (click)="onDownloadInventory()">
                <i class="fas fa-download"></i> Download Inventory
            </button>

            <button class="btn blue-btn btn-sm m-right-10" data-toggle="modal" data-target="#clearModal" >
                Clear Stock
            </button>

        </div>
    </div>
</div>


<div class="loading-shade" *ngIf="dataSource.loading$ | async">
    <mat-spinner></mat-spinner>
</div>
<div class="loading-shade spinLoad" *ngIf="loaderSpinner">
    <mat-spinner></mat-spinner>
</div>

<div class="table-responsive">
    <div class="table table-bordered table-hover grid-height">
        <table [dir]="langDir" mat-table [dataSource]="dataSource" matSort multiTemplateDataRows
            matSortActive="productName">
            <ng-container matColumnDef="action">
                <th class="table-column-300" mat-header-cell *matHeaderCellDef>
                </th>
                <td class="table-column-300" mat-cell *matCellDef="let inventory">
                    <button mat-icon-button (click)="toggleRow(inventory)">
                        <mat-icon *ngIf="inventory != expandedElement">chevron_right</mat-icon>
                        <mat-icon *ngIf="inventory == expandedElement">expand_more</mat-icon>
                    </button>

                    <button *hasClaim="'INVE_MANAGE_INVENTORY'" class="btn blue-btn btn-sm ml-4"
                        (click)="addInventory(inventory)">
                        <i class="fas fa-plus"></i> {{'ADD_INVENTORY' | translate}}
                    </button>
                </td>
            </ng-container>
            <ng-container matColumnDef="category">
                <th class="table-column-150" mat-header-cell *matHeaderCellDef mat-sort-header>Category</th>
                <td class="table-column-150" mat-cell *matCellDef="let row"> {{row?.productCategoryName}} </td>
            </ng-container>
            <ng-container matColumnDef="productName">
                <th class="table-column-300" mat-header-cell *matHeaderCellDef mat-sort-header>{{'PRODUCT_NAME' |
                    translate}}</th>
                <td class="table-column-300" mat-cell *matCellDef="let row"> {{row.productName}} </td>
            </ng-container>
            <ng-container matColumnDef="productCode">
                <th class="table-column-150" mat-header-cell *matHeaderCellDef mat-sort-header>Product Code</th>
                <td class="table-column-150" mat-cell *matCellDef="let row"> {{row?.productCode}} </td>
            </ng-container>
            <ng-container matColumnDef="brandName">
                <th class="table-column-150" mat-header-cell *matHeaderCellDef mat-sort-header>Brand Name</th>
                <td class="table-column-150" mat-cell *matCellDef="let row"> {{row.brandName}} </td>
            </ng-container>
            <ng-container matColumnDef="manufactureName">
                <th class="table-column-150" mat-header-cell *matHeaderCellDef mat-sort-header>Manufacturer</th>
                <td class="table-column-150" mat-cell *matCellDef="let row"> {{row?.manufacturerName}} </td>
            </ng-container>
            <ng-container matColumnDef="supplierName">
                <th class="table-column-250" mat-header-cell *matHeaderCellDef mat-sort-header>Supplier Name</th>
                <td class="table-column-250" mat-cell *matCellDef="let row"> {{row?.supplierName}} </td>
            </ng-container>
            <ng-container matColumnDef="openStock">
                <th class="table-column-50" mat-header-cell *matHeaderCellDef mat-sort-header>Opening Stock
                </th>
                <td class="table-column-50" mat-cell *matCellDef="let row"> {{row.openingStock}}</td>
            </ng-container>
            <ng-container matColumnDef="stock">
                <th class="table-column-50" mat-header-cell *matHeaderCellDef mat-sort-header>{{'STOCK' | translate}}
                </th>
                <td class="table-column-50" mat-cell *matCellDef="let row"> {{row.stock}}</td>
            </ng-container>
            
            <ng-container matColumnDef="unit">
                <th class="table-column-50" mat-header-cell *matHeaderCellDef mat-sort-header>{{'UNIT' | translate}}
                </th>
                <td class="table-column-50" mat-cell *matCellDef="let row">{{row.unitName}} </td>
            </ng-container>
            <ng-container matColumnDef="stockAmount">
                <th class="table-column-120" mat-header-cell *matHeaderCellDef mat-sort-header>Total Stock Amount
                </th>
                <td class="table-column-120" mat-cell *matCellDef="let row"> {{row.totalStockAmount | customCurrency}}</td>
            </ng-container>
            <ng-container matColumnDef="averagePurchasePrice">
                <th class="table-column-150" mat-header-cell *matHeaderCellDef mat-sort-header>
                        MRP
                </th>
                <td class="table-column-150" mat-cell *matCellDef="let row"> {{row?.mrp |
                    customCurrency}} </td>
            </ng-container>
            <ng-container matColumnDef="averageSalesPrice">
                <th class="table-column-150" mat-header-cell *matHeaderCellDef mat-sort-header>Purchase Price</th>
                <td class="table-column-150" mat-cell *matCellDef="let row"> {{row?.purchasePrice | customCurrency}}
                </td>
            </ng-container>
            <ng-container matColumnDef="Margin">
                <th class="table-column-150" mat-header-cell *matHeaderCellDef mat-sort-header>Margin</th>
                <td class="table-column-150" mat-cell *matCellDef="let row"> {{row.margin}}
                </td>
            </ng-container>
            <ng-container matColumnDef="salesPrice">
                <th class="table-column-150" mat-header-cell *matHeaderCellDef mat-sort-header>Sales Price</th>
                <td class="table-column-150" mat-cell *matCellDef="let row"> {{row.salePrice | customCurrency}}
                </td>
            </ng-container>
            <ng-container matColumnDef="closeStock">
                <th class="table-column-50" mat-header-cell *matHeaderCellDef mat-sort-header>Closing Stock
                </th>
                <td class="table-column-50" mat-cell *matCellDef="let row"> {{row.closingStock}}</td>
            </ng-container>


            <ng-container matColumnDef="action-search">
                <th class="pr-5" mat-header-cell *matHeaderCellDef> </th>
            </ng-container>
            <ng-container matColumnDef="category-search">
                <th mat-header-cell *matHeaderCellDef>
                    <input type="text" placeholder="Category" class="form-control w-90" [(ngModel)]="ProductCategoryFilter">
                </th>
            </ng-container>
            <ng-container matColumnDef="productName-search">
                <th mat-header-cell *matHeaderCellDef>
                    <input type="text" placeholder="Product" class="form-control w-90" [(ngModel)]="ProductNameFilter">
                </th>
            </ng-container>
            <ng-container matColumnDef="productCode-search">
                <th mat-header-cell *matHeaderCellDef>
                    <input type="text" placeholder="Code" class="form-control w-90" [(ngModel)]="ProductCodeFilter">
                </th>
            </ng-container>
            <ng-container matColumnDef="brandName-search">
                <th mat-header-cell *matHeaderCellDef>
                    <input type="text"  placeholder="Brand" class="form-control w-90" [(ngModel)]="BrandNameFilter">
                </th>
            </ng-container>
            <ng-container matColumnDef="manufactureName-search">
                <th mat-header-cell *matHeaderCellDef>
                </th>
            </ng-container>
            <ng-container matColumnDef="supplierName-search">
                <th mat-header-cell *matHeaderCellDef>
                    <input placeholder="{{'SUPPLIER' | translate}}" type="text" class="form-control w-90"
                        [formControl]="supplierNameControl" [matAutocomplete]="autoSupplier">
                    <mat-autocomplete [dir]="langDir" [autoActiveFirstOption]="true"
                        (optionSelected)='SupplierFilter=$event.option.value' #autoSupplier="matAutocomplete">
                        <mat-option value="">{{'NONE' | translate}}</mat-option>
                        <mat-option [dir]="langDir" *ngFor="let supplier of supplierList$ | async"
                            [value]="supplier.supplierName">
                            {{supplier.supplierName}}
                        </mat-option>
                    </mat-autocomplete>
                </th>
            </ng-container>
            <ng-container matColumnDef="openStock-search">
                <th class="pr-5" mat-header-cell *matHeaderCellDef> </th>
            </ng-container>
            <ng-container matColumnDef="stock-search">
                <th class="pr-5" mat-header-cell *matHeaderCellDef> </th>
            </ng-container>
            <ng-container matColumnDef="unit-search">
                <th class="pr-5" mat-header-cell *matHeaderCellDef>
                    <!-- <input type="text" class="form-control w-90" [(ngModel)]="UnitNameFilter"> -->
                </th>
            </ng-container>
            <ng-container matColumnDef="stockAmount-search">
                <th class="pr-5" mat-header-cell *matHeaderCellDef> </th>
            </ng-container>
            <ng-container matColumnDef="averagePurchasePrice-search">
                <th class="pr-5" mat-header-cell *matHeaderCellDef> </th>
            </ng-container>
            <ng-container matColumnDef="averageSalesPrice-search">
                <th class="pr-5" mat-header-cell *matHeaderCellDef> </th>
            </ng-container>
            <ng-container matColumnDef="Margin-search">
                <th class="pr-5" mat-header-cell *matHeaderCellDef> </th>
            </ng-container>
            <ng-container matColumnDef="salesPrice-search">
                <th class="pr-5" mat-header-cell *matHeaderCellDef> </th>
            </ng-container>
            <ng-container matColumnDef="closeStock-search">
                <th class="pr-5" mat-header-cell *matHeaderCellDef> </th>
            </ng-container>

            <ng-container matColumnDef="footer">
                <td mat-footer-cell colspan="16" *matFooterCellDef>
                    <mat-paginator [length]="inventoryResource.totalCount" [pageSize]="inventoryResource.pageSize"
                        [dir]="langDir" [pageSizeOptions]="[10, 20, 30]">
                    </mat-paginator>
                </td>
            </ng-container>
            <ng-container *ngIf="dataSource.count === 0" matColumnDef="no-records">
                <td mat-footer-cell colspan="7" *matFooterCellDef>
                    <b> {{'NO_DATA_FOUND' | translate}}</b>
                </td>
            </ng-container>
            <ng-container matColumnDef="expandedDetail">
                <td mat-cell *matCellDef="let inventoryObject" [attr.colspan]="displayedColumns.length">
                    <ng-container *ngIf="inventoryObject == expandedElement">
                        <div class="example-element-detail"
                            [@detailExpand]="inventoryObject == expandedElement ? 'expanded' : 'collapsed'">
                            <div class="inner-table mat-elevation-z8">
                                <app-inventory-history-list [inventory]="inventoryObject">
                                </app-inventory-history-list>
                            </div>
                        </div>
                    </ng-container>
                </td>
            </ng-container>
            <tr *matNoDataRow>
                <td colspan="9">
                    <span class="p-4 mt-4">
                        <b> {{'NO_DATA_FOUND' | translate}}</b>
                    </span>
                </td>
            </tr>
            <tr mat-header-row *matHeaderRowDef="displayedColumns;sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            <tr mat-header-row
            *matHeaderRowDef="['action-search','category-search','productName-search','productCode-search','brandName-search','manufactureName-search','supplierName-search','openStock-search','stock-search','unit-search','stockAmount-search','averagePurchasePrice-search','averageSalesPrice-search','Margin-search','salesPrice-search','closeStock-search'];sticky: true"
            class="example-second-header-row"> </tr>
            <tr mat-footer-row *matFooterRowDef="columnsToDisplay;sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
        </table>
    </div>
</div>

<!-- Upload InventoryModal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Upload Inventory</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div (click)="triggerFileInput()"><a style="cursor: pointer;">Click here to select file...</a>
                    {{showFileName}}</div>
            </div>
            <div class="modal-footer">
                <button #closeButton type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" (click)="uploadInventoryFiles()">Upload</button>
            </div>
        </div>
    </div>
</div>

  <!-- clear Inventory -->

<div class="modal fade" id="clearModal" tabindex="-1" role="dialog" aria-labelledby="clearModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close text-danger" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="clermsg">
                    Do You Want To Clear Stock ?
                </div>
            </div>
            <div class="modal-footer">
                <button #closeButton type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" (click)="clearInventory()">Clear</button>
            </div>
        </div>
    </div>
</div>